{% extends "base2.html" %}

{% load staticfiles %}
{% load crispy_forms_tags %}
{% load leaflet_tags %}

{% block title %}{{ block.super }}Projects{% endblock %}
{% block navbar-left %}
{% include "_navbar.html" with active_link="projects" %}
{% endblock %}

{% block page_header %}
{% include "finder_projects.html" %}
{% endblock page_header %}
{% block messages %}
{% if messages %}
{% for message in messages %}
<div class="main-content col-lg-10 col-md-9 col-sm-12 p-0 offset-lg-2 offset-md-3">
	<div class="alert alert-{{ message.tags }}">
		<a class="close" data-dismiss="alert">Ã—</a>
		{{ message|safe }}
	</div>
</div>
{% endfor %}
{% endif %}
{% endblock %}
{% block list_of_items %}
{% for project in projects %}
<div class="col-lg-4  col-sm-12 mb-4">
	<div class="card h-100 shadow-sm ">
		<a class="card-img-wrap "href="/project/{{project.id }}">

			{% if project.image1 %}
			<img class="card-img-top img-fluid img-zoom lazyload" src="{{ project.image1 }}" />
			{% else %}
			<img class="card-img-top img-fluid img-zoom lazyload" src="{% static 'site/img/project.png' %}" />
			{% endif %}

			<div class="upper">
				{% for country in countries %}
				{% if country.code == project.country %}
				<a class="badge badge-dark country" href="projects?country={{country.code}}">{{ country.name | upper }}</a>
				{% endif %}
				{% endfor %}
			</div>
		</a>
		<div class="card-body">
			<h5 class="card-title mt-3 mb-3"> <a class="card-link" href="/project/{{project.id }}">{{ project.name }}</a></h5>
			<div class="card-text mt-3">{{project.description | safe | truncatechars:100 }}</div>
			<br>
			{% for topic in project.topic.all %}<a class="badge badge-light" href="projects?keywords=&topic={{topic|urlencode}}">{{topic | upper}}</a> {% endfor %}<br>
			{% for keyword in project.keywords.all %} <a class="badge badge-light" href="projects?keywords={{keyword|urlencode}}">{{keyword | upper}}</a>  {% endfor %}
		</div><!-- End of card-body -->
		<div class="card-footer bg-white">
			<div class="row">
				<div class="col-6">
					<div id="featured{{project.id}}" class="float-left">
						{% if user.is_staff %}
						{% if project.id in featuredProjects %}
						<button class="btn btn-approved float-left"  onclick="setFeatured({{project.id}})" ><i class="fas fa-check"></i>&nbsp;Approved</button>
						{% else %}
						<button class="btn btn-pending"  onclick="setFeatured({{project.id}})"><i class="fas fa-hourglass-half mt-2"></i>&nbsp;Pending...</button>
						{% endif %}
						{% else %}
						{% if project.id in featuredProjects %}
						<button class="btn  float-left"><i class="fas fa-check"></i>&nbsp;Approved</button>
						{% else %}
						<button class="btn  float-left" data-toggle="tooltip" data-placement="top" title="Waiting for moderation under EU-CITIZEN.SCIENCE criteria">
							<i class="fas fa-hourglass-half"></i>&nbsp;Pending...</button>
							{% endif %}

							{% endif %}
							<div id="hidden{{project.id}}" style="display:inline-block">
								{% if user.is_staff %}
								{% if project.hidden %}
								<a style="color: Tomato;" onclick="setHidden({{project.id}}, false)"><i class="fas fa-eye-slash"></i>Hidden</a>
								{% else %}
								<button type="button" class="btn btn-labeled btn-success" onclick="setHidden({{project.id}}, true)">
									<span class="btn-label"><i class="fas fa-eye"></i></span>Success</button>
									{% endif %}
									{% endif %}
								</div>
							</div>
						</div>
						<div class="col-6">
							{% if user.is_authenticated %}
							<div id="followed{{project.id}}">
								{% if project.id in followedProjects %}
								<button type="button" class="btn btn-outline-primary float-right" onclick="setFollowedProject({{project.id}},{{user.id}})">Following</button>
								{% else %}
								<button type="button" class="btn btn-outline-secondary float-right" onclick="setFollowedProject({{project.id}},{{user.id}})">Follow</button>
								{% endif %}
							</div>

							{% endif %}

						</div>
					</div>
				</div><!-- end of card footer -->
			</div><!-- end of card -->
		</div>
		{% endfor %}
		<div class="col-lg-12">
			{% include "paginator.html" %}
		</div>
		{% endblock list_of_items %}
	</main>


	{% block scripts %}
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.15.0/umd/popper.js"
	integrity="sha256-7BfFV/dSvQT4pGBvRAIt6JDXsehb92DQqpGUndLCPQ4=" crossorigin="anonymous"></script>
	<script
	src="https://cdn.rawgit.com/xcash/bootstrap-autocomplete/3de7ad37/dist/latest/bootstrap-autocomplete.js"></script>

	<script>
		function setFeatured(idProject){
			var htmlId = "featured" + idProject;
			var request = $.ajax(
			{
				type: "POST",
				url: "{% url 'setFeatured' %}",
				data: {
					"project_id": idProject,
					csrfmiddlewaretoken: '{{ csrf_token }}'
				},
				success: function (response) {
					$("#"+htmlId).load(" #"+htmlId);
				}
			}
			);
		}

		function setHidden(idProject, hidden){
			var htmlId = "hidden" + idProject;
			var request = $.ajax(
			{
				type: "POST",
				url: "{% url 'setHidden' %}",
				data: {
					"project_id": idProject,
					"hidden": hidden,
					csrfmiddlewaretoken: '{{ csrf_token }}'
				},
				success: function (response) {
					$("#"+htmlId).load(" #"+htmlId);
				}
			}
			);
		}

		function setFollowedProject(idProject, idUser){
			var htmlId = "followed" + idProject;
			var request = $.ajax(
			{
				type: "POST",
				url: "{% url 'setFollowedProject' %}",
				data: {
					"project_id": idProject,
					"user_id": idUser,
					csrfmiddlewaretoken: '{{ csrf_token }}'
				},
				success: function (response) {
					$("#"+htmlId).load(" #"+htmlId);
				}
			}
			);
		}
	</script>
	<script>
		$('.basicAutoComplete').autoComplete(
		{ minLength: 3 }
		);

		$("#keywords").blur(function () {
			var keywords = $(this).val();
			$('#searchProjects').submit();
		});

		$('.basicAutoComplete').on('autocomplete.select', function (evt, item) {
			$('#searchProjects').submit();
		});

		$(function () {
			$('#topic').on('change', function () {
				var topic = $(this).val();
				$('#searchProjects').submit();
			});
		});

		$(function () {
			$('.status-select').on('change', function () {
				var status = $(this).val();
				$('#searchProjects').submit();
			});
		});

		$(function () {
			$('#country').on('change', function () {
				var country = $(this).val();
				$('#searchProjects').submit();
			});
		});

		$("#host").blur(function () {
			$('#searchProjects').submit();
		});

		$(function () {
			$('#featuredCheck').on('click', function () {
				var featuredCheck = $(this).val();
				$('#searchProjects').submit();
			});
		});
	</script>
	<script>
		$(document).ready(function() {
			// executes when HTML-Document is loaded and DOM is ready
			console.log("document is ready");
			$( ".card" ).hover(
			function() {
				$(this).addClass('shadow-none').css('cursor', 'pointer');
			}, function() {
				$(this).removeClass('shadow-none');
			}
			);

			// document ready
		});
	</script>
	{% endblock scripts %}
