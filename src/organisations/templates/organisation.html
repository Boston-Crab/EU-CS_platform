{% extends "base_r2.html" %}

{% load staticfiles %}
{% load crispy_forms_tags %}
{% load leaflet_tags %}
{% load thumbnail %}
{% block head %}
{{ block.super }}
{% leaflet_js %}
{% leaflet_css %}

{% endblock head %}
{% block title %}Organisation{% endblock %}

{% block list_of_items %}
{{ permissionForm.media.css }}
<div class="container">
	<div class="card">
		<div class="card-body">
			<div class="row">
				<div class="col-sm-3 col-12">
					<img title="organisation logo" target="_blank"
					class="img-fluid mb-3" src="{{ organisation.logo|default:'/media/default_profile.png' }}">
					<div><strong>Contact Point</strong>: {{ organisation.contactPoint }} </div>
					<div class="mb-5"><strong>Contact Point Email</strong>: {{ organisation.contactPointEmail }}</div>
				</div>
				<div class="col-sm-9 col-12">
					<div class="row">
						<div class="col-9">
							<h3>{{ organisation.name }}</h3>
						</div>
						<div class="col-3 text-right">
							<a target="_blank" href="{% if 'http' not in organisation.url %}//{%endif%}{{organisation.url}}"
							class="colorpurple"><i class="fas fa-external-link-square-alt"></i> Go to Organisation</a>
						</div>
					</div>

					{{ organisation.description }}
					{% if associatedProjects.all %}
					<h5 class="mt-3">Projects</h5>
					{% for project in associatedProjects.all %}
					<a class="badge badge-light pt-1" href="/project/{{project.id}}">{{project|upper}}</a>
					{% endfor %}
					{% endif %}
					{% if associatedResources.all %}
					<h5 class="mt-3">Resources</h5>
					{% for resource in associatedResources.all %}
					<a class="badge badge-light pt-1" href="/resource/{{resource.id}}">{{resource|upper}}</a>
					{% endfor %}
					{% endif %}
					{% if members.all %}
					<h5 class="mt-3">Members</h5>
					{% for member in members.all %}
					<a class="badge badge-light pt-1" href="/users/{{member.slug}}">{{member.user.name | upper}}</a>
					{% endfor %}
					{% endif %}
					<div class="mt-4">
						{% leaflet_map "map" callback="window.map_init_basic" %}
					</div>
				</div>
			</div>
		</div><!-- end of card body -->
		{% if user.is_staff %}
			<permissionForm>
				{% csrf_token %}
				{{ permissionForm.usersAllowed | as_crispy_field }}
				{{ permissionForm.selectedUsers | as_crispy_field }}
				{{ permissionForm.usersCollection | as_crispy_field }}
			</permissionForm>
		{% endif %}
		{% if editable %}
		<div class="card-footer">
			<a href="{% url 'delete_organisation' organisation.id %}" class="btn btn-outline btn-red float-right ml-2 mt-2">
				<span class="fas fa-trash-alt"></span>&nbsp;Delete Organisation
			</a>
			<a href="{% url 'edit_organisation' organisation.id %}" class="btn btn-outline btn-green float-right ml-2 mt-2">
				<i class="fas fa-edit"></i> Edit Organisation
			</a>
		</div>
		{% endif %}

	</div>
</div>

{% endblock list_of_items%}

{% block scripts %}
<script>

	$(function () {
		var users = $("#id_usersCollection").val();
		var users = users.split(",");		
		var selectedUsers = $("#id_selectedUsers").val().split(",");
		for (user of users){
		var found = false;
		for(sel of selectedUsers){
			if(sel.trim() == user.trim()){
			found = true;
			$("#id_usersAllowed").append("<option value='" + user +"' selected> " + user + " </option>");
			}
		}
		if(!found){
			$("#id_usersAllowed").append("<option value='" + user +"'> " + user + " </option>");
		}
		}

		$('#id_usersAllowed').on('change', function () {
			users = $("#id_usersAllowed option:selected").map(function () {
				return $.trim($(this).text());
			}).get().join(',');

			var idOrganisation = {{organisation.id}};
			var request = $.ajax(
			{
				type: "POST",
				url: "{% url 'allowUserOrganisation' %}",
				data: {
				"organisation_id": idOrganisation,
				"users": users,
				csrfmiddlewaretoken: '{{ csrf_token }}'
				},
				success: function (response) {

				}
			}
		);
		});
	});


	var map;
	var marker_layer = new L.marker([50.5, 30.5]);
	function map_init_basic (leafmap, options) {
		map = leafmap;
		map.setView([{{organisation.latitude}}, {{organisation.longitude}}], 12)
		new L.marker([{{organisation.latitude}},{{organisation.longitude}}]).addTo(map);
	}
</script>
{{ permissionForm.media.js }}
{% endblock scripts %}
